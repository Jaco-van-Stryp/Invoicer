<div class="page-header">
  <div>
    <h1 class="text-3xl font-bold m-0">Invoices</h1>
    <p class="text-muted-color mt-1 mb-0">Manage your invoices</p>
  </div>
  <div class="flex items-center gap-2">
    <button class="view-toggle" (click)="toggleView()" title="Toggle view">
      <i [class]="viewMode() === 'cards' ? 'pi pi-table' : 'pi pi-th-large'" aria-hidden="true"></i>
    </button>
    <button class="btn-gradient" (click)="openNew()">
      <i class="pi pi-plus" aria-hidden="true"></i>
      New Invoice
    </button>
  </div>
</div>

<!-- Card View -->
@if (viewMode() === 'cards') {
  <div class="cards-grid">
    @for (invoice of invoices(); track invoice.id) {
      <div class="invoice-card">
        <div class="invoice-card-header">
          <div class="invoice-card-number">{{ invoice.invoiceNumber }}</div>
          <p-tag
            [value]="invoice.status || 'Unpaid'"
            [severity]="statusSeverity(invoice.status)"
          />
        </div>
        <div class="invoice-card-client">{{ invoice.clientName }}</div>
        <div class="invoice-card-dates">
          <div class="date-item">
            <span class="date-label">Issued</span>
            <span class="date-value">{{ invoice.invoiceDate | date: 'MMM d, y' }}</span>
          </div>
          <div class="date-item">
            <span class="date-label">Due</span>
            <span class="date-value">{{ invoice.invoiceDue | date: 'MMM d, y' }}</span>
          </div>
        </div>
        <div class="invoice-card-amounts">
          <div class="amount-item">
            <span class="amount-label">Total</span>
            <span class="amount-value">{{ invoice.totalDue ?? 0 | currency }}</span>
          </div>
          <div class="amount-item">
            <span class="amount-label">Paid</span>
            <span class="amount-value paid">{{ invoice.totalPaid ?? 0 | currency }}</span>
          </div>
        </div>
        <div class="invoice-card-actions">
          <p-button
            icon="pi pi-envelope"
            [rounded]="true"
            [outlined]="true"
            severity="info"
            (click)="sendEmail(invoice)"
            pTooltip="Email Invoice"
          />
          <p-button
            icon="pi pi-dollar"
            [rounded]="true"
            [outlined]="true"
            severity="success"
            (click)="openPaymentDialog(invoice)"
            pTooltip="Record Payment"
          />
          <p-button
            icon="pi pi-pencil"
            [rounded]="true"
            [outlined]="true"
            (click)="editInvoice(invoice)"
            pTooltip="Edit"
          />
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [outlined]="true"
            severity="danger"
            (click)="deleteInvoice(invoice)"
            pTooltip="Delete"
          />
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <i class="pi pi-file-o" aria-hidden="true"></i>
        <p>No invoices found. Click "New Invoice" to create one.</p>
      </div>
    }
  </div>
} @else {
  <!-- Table View -->
  <div class="table-card">
    <div class="table-toolbar">
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input pInputText type="text" placeholder="Search invoices..." (input)="onFilter($event)" />
      </p-iconfield>
    </div>

    <p-table
      #dt
      [value]="invoices()"
      [loading]="loading()"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[5, 10, 25]"
      [globalFilterFields]="['invoiceNumber', 'clientName']"
      [scrollable]="true"
      dataKey="id"
    >
      <ng-template #header>
        <tr>
          <th pSortableColumn="invoiceNumber">Invoice # <p-sortIcon field="invoiceNumber" /></th>
          <th pSortableColumn="clientName">Client <p-sortIcon field="clientName" /></th>
          <th pSortableColumn="invoiceDate">Date <p-sortIcon field="invoiceDate" /></th>
          <th pSortableColumn="invoiceDue">Due Date <p-sortIcon field="invoiceDue" /></th>
          <th>Status</th>
          <th>Total</th>
          <th>Paid</th>
          <th style="width: 12rem">Actions</th>
        </tr>
      </ng-template>
      <ng-template #body let-invoice>
        <tr>
          <td>{{ invoice.invoiceNumber }}</td>
          <td>{{ invoice.clientName }}</td>
          <td>{{ invoice.invoiceDate | date: 'mediumDate' }}</td>
          <td>{{ invoice.invoiceDue | date: 'mediumDate' }}</td>
          <td>
            <p-tag
              [value]="invoice.status || 'Unpaid'"
              [severity]="statusSeverity(invoice.status)"
            />
          </td>
          <td>{{ invoice.totalDue ?? 0 | currency }}</td>
          <td>{{ invoice.totalPaid ?? 0 | currency }}</td>
          <td>
            <div class="flex gap-2">
              <p-button
                icon="pi pi-envelope"
                [rounded]="true"
                [text]="true"
                severity="info"
                (click)="sendEmail(invoice)"
                pTooltip="Email Invoice"
              />
              <p-button
                icon="pi pi-dollar"
                [rounded]="true"
                [text]="true"
                severity="success"
                (click)="openPaymentDialog(invoice)"
                pTooltip="Record Payment"
              />
              <p-button
                icon="pi pi-pencil"
                [rounded]="true"
                [text]="true"
                (click)="editInvoice(invoice)"
                pTooltip="Edit"
              />
              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                [text]="true"
                severity="danger"
                (click)="deleteInvoice(invoice)"
                pTooltip="Delete"
              />
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template #emptymessage>
        <tr>
          <td colspan="8" class="text-center py-6 text-muted-color">
            No invoices found. Click "New Invoice" to create one.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
}

<app-invoice-form-dialog
  [(visible)]="dialogVisible"
  [invoice]="selectedInvoice()"
  (saved)="onSaved()"
/>

<app-record-payment-dialog
  [(visible)]="paymentDialogVisible"
  [invoice]="selectedInvoiceForPayment()"
  (saved)="onSaved()"
/>

<p-confirmDialog />
