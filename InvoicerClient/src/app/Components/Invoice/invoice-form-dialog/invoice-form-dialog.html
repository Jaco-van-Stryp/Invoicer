<p-dialog
  [header]="dialogTitle()"
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '48rem' }"
  [closable]="true"
>
  <div class="flex flex-col gap-5 mt-4">
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium" for="invoiceClient">Client *</label>
      <p-select
        id="invoiceClient"
        [options]="clients()"
        [ngModel]="selectedClientId()"
        (ngModelChange)="selectedClientId.set($event)"
        optionLabel="name"
        optionValue="id"
        placeholder="Select a client"
        styleClass="w-full"
        [loading]="loadingData()"
        [filter]="true"
        filterPlaceholder="Search clients..."
        appendTo="body"
      />
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="flex flex-col gap-1">
        <label class="text-sm font-medium" for="invoiceDate">Invoice Date *</label>
        <p-datepicker
          id="invoiceDate"
          [ngModel]="invoiceDate()"
          (ngModelChange)="invoiceDate.set($event)"
          dateFormat="yy-mm-dd"
          styleClass="w-full"
          appendTo="body"
        />
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm font-medium" for="invoiceDue">Due Date *</label>
        <p-datepicker
          id="invoiceDue"
          [ngModel]="invoiceDue()"
          (ngModelChange)="invoiceDue.set($event)"
          dateFormat="yy-mm-dd"
          styleClass="w-full"
          appendTo="body"
        />
      </div>
    </div>

    <!-- Products section -->
    <div class="products-section">
      <div class="products-section-header">
        <h3 class="text-base font-semibold m-0">Products</h3>
        <p-button
          label="Add Product"
          icon="pi pi-plus"
          [text]="true"
          size="small"
          (click)="addLine()"
        />
      </div>

      @if (productLines().length === 0) {
        <p class="text-muted-color text-sm text-center py-4">
          No products added. Click "Add Product" to begin.
        </p>
      }

      <div class="product-rows">
        @for (line of productLines(); track $index) {
          <div class="product-row">
            <div class="product-row-select">
              <p-select
                [options]="products()"
                [ngModel]="line.productId"
                (ngModelChange)="updateLineProduct($index, $event)"
                optionLabel="name"
                optionValue="id"
                placeholder="Select product"
                styleClass="w-full"
                [loading]="loadingData()"
                [filter]="true"
                filterPlaceholder="Search products..."
                appendTo="body"
              />
            </div>
            <div class="product-row-qty">
              <p-inputNumber
                [ngModel]="line.quantity"
                (ngModelChange)="updateLineQuantity($index, $event)"
                [min]="1"
                [showButtons]="true"
                buttonLayout="horizontal"
                incrementButtonIcon="pi pi-plus"
                decrementButtonIcon="pi pi-minus"
                styleClass="w-full"
              />
            </div>
            <div class="product-row-total">
              {{ getLineTotal(line) | currency }}
            </div>
            <p-button
              icon="pi pi-times"
              [rounded]="true"
              [text]="true"
              severity="danger"
              size="small"
              (click)="removeLine($index)"
              pTooltip="Remove"
              aria-label="Remove product"
            />
          </div>
        }
      </div>

      @if (productLines().length > 0) {
        <div class="grand-total">
          <span class="text-sm font-semibold text-muted-color">Grand Total</span>
          <span class="grand-total-amount">{{ grandTotal() | currency }}</span>
        </div>
      }
    </div>
  </div>

  <ng-template #footer>
    <p-button label="Cancel" [text]="true" severity="secondary" (click)="visible.set(false)" />
    <p-button
      [label]="isEditing() ? 'Update Invoice' : 'Create Invoice'"
      icon="pi pi-check"
      [loading]="saving()"
      [disabled]="!isFormValid()"
      (click)="save()"
    />
  </ng-template>
</p-dialog>
