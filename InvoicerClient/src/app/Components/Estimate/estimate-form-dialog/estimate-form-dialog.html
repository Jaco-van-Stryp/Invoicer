<p-dialog
  [header]="isEditing() ? 'Edit Estimate' : 'New Estimate'"
  [(visible)]="visible"
  [modal]="true"
  [style]="{ width: '48rem' }"
  [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  [draggable]="false"
  [resizable]="false"
>
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-col gap-4 mt-4">
    <div class="form-grid">
      <div class="form-field">
        <label for="client">Client *</label>
        <p-select
          id="client"
          formControlName="clientId"
          [options]="clients()"
          optionLabel="name"
          optionValue="id"
          placeholder="Select a client"
          styleClass="w-full"
          [filter]="true"
          filterPlaceholder="Search clients..."
          appendTo="body"
        />
      </div>

      <div class="form-field">
        <label for="status">Status *</label>
        <p-select
          id="status"
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full"
          appendTo="body"
        />
      </div>

      <div class="form-field">
        <label for="estimateDate">Estimate Date *</label>
        <p-datepicker
          id="estimateDate"
          formControlName="estimateDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-full"
          appendTo="body"
        />
      </div>

      <div class="form-field">
        <label for="expiresOn">Expires On *</label>
        <p-datepicker
          id="expiresOn"
          formControlName="expiresOn"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-full"
          appendTo="body"
        />
      </div>
    </div>

    <div class="form-field">
      <label for="notes">Notes</label>
      <input pInputText id="notes" formControlName="notes" class="w-full" />
    </div>

    <!-- Products section -->
    <div class="products-section">
      <div class="products-section-header">
        <h3 class="text-base font-semibold m-0">Products</h3>
        <p-button
          type="button"
          label="Add Product"
          icon="pi pi-plus"
          [text]="true"
          size="small"
          (click)="addProduct()"
        />
      </div>

      @if (productLines().length === 0) {
        <p class="text-muted-color text-sm text-center py-4">
          No products added. Click "Add Product" to begin.
        </p>
      }

      <div class="product-rows">
        @for (line of productLines(); track $index) {
          <div class="product-row">
            <div class="product-row-select">
              <p-select
                [options]="products()"
                [ngModel]="line.productId"
                (ngModelChange)="updateLineProduct($index, $event)"
                [ngModelOptions]="{ standalone: true }"
                optionLabel="name"
                optionValue="id"
                placeholder="Select product"
                styleClass="w-full"
                [filter]="true"
                filterPlaceholder="Search products..."
                appendTo="body"
              />
            </div>
            <div class="product-row-qty">
              <p-inputNumber
                [ngModel]="line.quantity"
                (ngModelChange)="updateLineQuantity($index, $event)"
                [ngModelOptions]="{ standalone: true }"
                [min]="1"
                [showButtons]="true"
                buttonLayout="horizontal"
                incrementButtonIcon="pi pi-plus"
                decrementButtonIcon="pi pi-minus"
                styleClass="w-full"
              />
            </div>
            <div class="product-row-total">
              {{ getLineTotal(line) | currency }}
            </div>
            <p-button
              type="button"
              icon="pi pi-times"
              [rounded]="true"
              [text]="true"
              severity="danger"
              size="small"
              (click)="removeProduct($index)"
              aria-label="Remove product"
            />
          </div>
        }
      </div>

      @if (productLines().length > 0) {
        <div class="grand-total">
          <span class="text-sm font-semibold text-muted-color">Grand Total</span>
          <span class="grand-total-amount">{{ grandTotal() | currency }}</span>
        </div>
      }
    </div>
  </form>

  <ng-template #footer>
    <p-button
      label="Cancel"
      severity="secondary"
      [outlined]="true"
      [text]="true"
      (click)="onCancel()"
      [disabled]="loading()"
    />
    <p-button
      [label]="isEditing() ? 'Update Estimate' : 'Create Estimate'"
      icon="pi pi-check"
      (click)="onSubmit()"
      [loading]="loading()"
    />
  </ng-template>
</p-dialog>
